<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Zane,pi@0php.net"><title>Slim 框架源码解读 · 一只贱熊猫的博客</title><meta name="description" content="0x00 前言Slim 是由《PHP The Right Way》作者开发的一款 PHP 微框架，代码量不算多（比起其它重型框架来说），号称可以一下午就阅读完（我觉得前提是熟悉 Slim 所用的组件）。不过比起其它框架来说真的还算容易阅读的了，所以是比较适合我这种新手学习一款框架。因为文章篇幅限制所"><meta name="keywords" content="PHP,Web,Swoole,HTML,CSS"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">一只贱熊猫的博客</a></h3><div class="description"><p>夫夷以近，则游者众；险以远，则至者少。</p></div></div></div><ul class="social-links"><li><a href="http://github.com/zanemmm"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/logo.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Slim 框架源码解读</a></h3></div><div class="post-content"><h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>Slim 是由《PHP The Right Way》作者开发的一款 PHP 微框架，代码量不算多（比起其它重型框架来说），号称可以一下午就阅读完（我觉得前提是熟悉 Slim 所用的组件）。不过比起其它框架来说真的还算容易阅读的了，所以是比较适合我这种新手学习一款框架。因为文章篇幅限制所以采用抓大放小的方式所以会避过一些不重要的内容（我才不会告诉你有些地方我还没看很明白/(ㄒoㄒ)/）。</p>
<h2 id="0x01-生命周期"><a href="#0x01-生命周期" class="headerlink" title="0x01 生命周期"></a>0x01 生命周期</h2><p><img src="Slim-框架源码解读/slim.png" alt="Slim 生命周期"></p>
<h2 id="0x02-从入口文件开始"><a href="#0x02-从入口文件开始" class="headerlink" title="0x02 从入口文件开始"></a>0x02 从入口文件开始</h2><p>在 <a href="https://github.com/slimphp/Slim#usage" target="_blank" rel="noopener">Slim</a> 项目的 README 里我们可以看见官方所给出的入口文件 index.php 的 demo，真的是很微(⊙﹏⊙)。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">require</span> <span class="string">'vendor/autoload.php'</span>;</span><br><span class="line"></span><br><span class="line">$app = <span class="keyword">new</span> Slim\App();</span><br><span class="line"></span><br><span class="line">$app-&gt;get(<span class="string">'/hello/&#123;name&#125;'</span>, <span class="function"><span class="keyword">function</span> <span class="params">($request, $response, $args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $response-&gt;getBody()-&gt;write(<span class="string">"Hello, "</span> . $args[<span class="string">'name'</span>]);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$app-&gt;run();</span><br></pre></td></tr></table></figure>
<p>上面这段代码作用如下</p>
<ul>
<li>引入 composer 的自动加载脚本 <code>vendor/autoload.php</code></li>
<li>实例化 <code>App</code> 类</li>
<li>定义一个闭包路由</li>
<li><code>App</code> 实例执行 <code>run</code> 方法</li>
</ul>
<p>很容易看出整段代码最重要的便是 <code>App</code> 类，下面我们来分析一下 <code>App</code> 类。</p>
<h2 id="0x03-构造一切的核心-App"><a href="#0x03-构造一切的核心-App" class="headerlink" title="0x03 构造一切的核心 App"></a>0x03 构造一切的核心 App</h2><p> 首先我们看看 <code>App</code> 的构造函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Create new application</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ContainerInterface|array $container Either a ContainerInterface or an associative array of app settings</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> InvalidArgumentException when no container is provided that implements ContainerInterface</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($container = [])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (is_array($container)) &#123;</span><br><span class="line">        $container = <span class="keyword">new</span> Container($container);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!$container <span class="keyword">instanceof</span> ContainerInterface) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidArgumentException(<span class="string">'Expected a ContainerInterface'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;container = $container;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们发现 <code>App</code> 依赖一个容器接口 <code>ContainerInterface</code>。如果没有传递容器，构造函数将实例化 <code>Container</code> 类，作为  <code>App</code>  的容器。因为 <code>App</code> 依赖的是 <code>ContainerInterface</code> 接口而不是具体实现，所以我们可以使用任意实现了 <code>ContainerInterface</code> 接口的容器作为参数注入 <code>App</code> 但是因为我们现在研究 Slim 框架所以还是要分析 <code>Container</code> 类。</p>
<h2 id="0x04-容器-Container"><a href="#0x04-容器-Container" class="headerlink" title="0x04 容器 Container"></a>0x04 容器 Container</h2><p>Slim 的容器是基于 <a href="https://github.com/silexphp/Pimple" target="_blank" rel="noopener">pimple/pimple</a> 这个容器实现的（想了解 <code>Pimple</code> 容器可以看这篇文章 <a href="https://segmentfault.com/a/1190000010018086" target="_blank" rel="noopener">PHP容器–Pimple运行流程浅析</a>），<code>Container</code> 类增加了配置用户设置、注册默认服务的功能并实现了 <code>ContainerInterface</code> 接口。部分代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> $defaultSettings = [</span><br><span class="line">	<span class="comment">// 篇幅限制省略不贴</span></span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">(array $values = [])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">parent</span>::__construct($values);</span><br><span class="line">	</span><br><span class="line">    $userSettings = <span class="keyword">isset</span>($values[<span class="string">'settings'</span>]) ? $values[<span class="string">'settings'</span>] : [];</span><br><span class="line">    <span class="keyword">$this</span>-&gt;registerDefaultServices($userSettings);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注册默认服务</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">registerDefaultServices</span><span class="params">($userSettings)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $defaultSettings = <span class="keyword">$this</span>-&gt;defaultSettings;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 向容器中注册 settings 服务</span></span><br><span class="line"><span class="comment">     * 该服务将返回 App 相关的设置</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> array|\ArrayAccess</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">$this</span>[<span class="string">'settings'</span>] = <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($userSettings, $defaultSettings)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// array_merge 将 $defaultSettings 和 $userSettings 合并</span></span><br><span class="line">        <span class="comment">// $defaultSettings 与 $userSettings 中相同的键名会覆盖为 $userSettings 的值</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Collection(array_merge($defaultSettings, $userSettings));</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    $defaultProvider = <span class="keyword">new</span> DefaultServicesProvider();</span><br><span class="line">    $defaultProvider-&gt;register(<span class="keyword">$this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实例化该容器时的任务就是将 <code>$values</code> 数组包含的服务注册到容器里，如果 <code>$values</code> 存在 <code>settings</code> 则将其和<code>$defaultSettings</code> 合并后再注册到容器中，最后通过 <code>DefaultServicesProvider</code> 将默认的服务都注册到容器里。</p>
<h2 id="0x05-注册默认服务-DefaultServicesProvider"><a href="#0x05-注册默认服务-DefaultServicesProvider" class="headerlink" title="0x05 注册默认服务 DefaultServicesProvider"></a>0x05 注册默认服务 DefaultServicesProvider</h2><p><code>DefaultServicesProvider</code> 的 <code>register</code> 方法向容器注册了许多服务包括 <code>environment</code> 、<code>request</code>、<code>response</code>、<code>router</code> 等，由于篇幅限制下面只展示 <code>register</code> 方法里比较重要的片段。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($container[<span class="string">'environment'</span>])) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This service MUST return a shared instance</span></span><br><span class="line"><span class="comment">     * of \Slim\Interfaces\Http\EnvironmentInterface.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> EnvironmentInterface</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    $container[<span class="string">'environment'</span>] = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Environment($_SERVER);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($container[<span class="string">'request'</span>])) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * PSR-7 Request object</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Container $container</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ServerRequestInterface</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    $container[<span class="string">'request'</span>] = <span class="function"><span class="keyword">function</span> <span class="params">($container)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Request::createFromEnvironment($container-&gt;get(<span class="string">'environment'</span>));</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($container[<span class="string">'response'</span>])) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * PSR-7 Response object</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Container $container</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ResponseInterface</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    $container[<span class="string">'response'</span>] = <span class="function"><span class="keyword">function</span> <span class="params">($container)</span> </span>&#123;</span><br><span class="line">        $headers = <span class="keyword">new</span> Headers([<span class="string">'Content-Type'</span> =&gt; <span class="string">'text/html; charset=UTF-8'</span>]);</span><br><span class="line">        $response = <span class="keyword">new</span> Response(<span class="number">200</span>, $headers);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $response-&gt;withProtocolVersion($container-&gt;get(<span class="string">'settings'</span>)[<span class="string">'httpVersion'</span>]);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($container[<span class="string">'router'</span>])) &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * This service MUST return a SHARED instance</span></span><br><span class="line"><span class="comment">     * of \Slim\Interfaces\RouterInterface.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> Container $container</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> RouterInterface</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    $container[<span class="string">'router'</span>] = <span class="function"><span class="keyword">function</span> <span class="params">($container)</span> </span>&#123;</span><br><span class="line">        $routerCacheFile = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>($container-&gt;get(<span class="string">'settings'</span>)[<span class="string">'routerCacheFile'</span>])) &#123;</span><br><span class="line">            $routerCacheFile = $container-&gt;get(<span class="string">'settings'</span>)[<span class="string">'routerCacheFile'</span>];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        $router = (<span class="keyword">new</span> Router)-&gt;setCacheFile($routerCacheFile);</span><br><span class="line">        <span class="keyword">if</span> (method_exists($router, <span class="string">'setContainer'</span>)) &#123;</span><br><span class="line">            $router-&gt;setContainer($container);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $router;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="0x06-注册路由"><a href="#0x06-注册路由" class="headerlink" title="0x06 注册路由"></a>0x06 注册路由</h2><p>在入口文件中我们可以看见通过 <code>$app-&gt;get(...)</code> 注册路由的方式，在 <code>App</code> 类里我们看见如下代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/********************************************************************************</span></span><br><span class="line"><span class="comment"> * Router proxy methods</span></span><br><span class="line"><span class="comment"> *******************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Add GET route</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string $pattern  The route URI pattern</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  callable|string  $callable The route callback routine</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> \Slim\Interfaces\RouteInterface</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($pattern, $callable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;map([<span class="string">'GET'</span>], $pattern, $callable);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Add route with multiple methods</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string[] $methods  Numeric array of HTTP method names</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  string   $pattern  The route URI pattern</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  callable|string    $callable The route callback routine</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> RouteInterface</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">map</span><span class="params">(array $methods, $pattern, $callable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 若是闭包路由则通过 bindTo 方法绑定闭包的 $this 为容器</span></span><br><span class="line">    <span class="keyword">if</span> ($callable <span class="keyword">instanceof</span> Closure) &#123;</span><br><span class="line">        $callable = $callable-&gt;bindTo(<span class="keyword">$this</span>-&gt;container);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 通过容器获取 Router 并新增一条路由</span></span><br><span class="line">    $route = <span class="keyword">$this</span>-&gt;container-&gt;get(<span class="string">'router'</span>)-&gt;map($methods, $pattern, $callable);</span><br><span class="line">    <span class="comment">// 将容器添加进路由</span></span><br><span class="line">    <span class="keyword">if</span> (is_callable([$route, <span class="string">'setContainer'</span>])) &#123;</span><br><span class="line">        $route-&gt;setContainer(<span class="keyword">$this</span>-&gt;container);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 设置 outputBuffering 配置项</span></span><br><span class="line">    <span class="keyword">if</span> (is_callable([$route, <span class="string">'setOutputBuffering'</span>])) &#123;</span><br><span class="line">        $route-&gt;setOutputBuffering(<span class="keyword">$this</span>-&gt;container-&gt;get(<span class="string">'settings'</span>)[<span class="string">'outputBuffering'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $route;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>App</code> 类中的 <code>get</code>、<code>post</code>、<code>put</code>、<code>patch</code>、<code>delete</code>、<code>options</code>、<code>any</code> 等方法都是对 <code>Router</code> 的 <code>map</code> 方法简单封装，让我好奇的那路由组是怎么实现的？下面我们看看 <code>Slim\App</code> 的 <code>group</code> 方法，示例如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Route Groups</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This method accepts a route pattern and a callback. All route</span></span><br><span class="line"><span class="comment"> * declarations in the callback will be prepended by the group(s)</span></span><br><span class="line"><span class="comment"> * that it is in.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> string   $pattern</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> callable $callable</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> RouteGroupInterface</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">group</span><span class="params">($pattern, $callable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// pushGroup 将构造一个 RouteGroup 实例并插入 Router 的 routeGroups 栈中，然后返回该 RouteGroup 实例，即 $group 为 RouteGroup 实例</span></span><br><span class="line">    $group = <span class="keyword">$this</span>-&gt;container-&gt;get(<span class="string">'router'</span>)-&gt;pushGroup($pattern, $callable);</span><br><span class="line">    <span class="comment">// 设置路由组的容器</span></span><br><span class="line">    $group-&gt;setContainer(<span class="keyword">$this</span>-&gt;container);</span><br><span class="line">    <span class="comment">// 执行 RouteGroup 的 __invoke 方法</span></span><br><span class="line">    $group(<span class="keyword">$this</span>);</span><br><span class="line">    <span class="comment">// Router 的 routeGroups 出栈</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;container-&gt;get(<span class="string">'router'</span>)-&gt;popGroup();</span><br><span class="line">    <span class="keyword">return</span> $group;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码中最重要的是 <code>$group($this);</code> 这句执行了什么？我们跳转到 <code>RouteGroup</code> 类中找到 <code>__invoke</code> 方法，代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Invoke the group to register any Routable objects within it.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> App $app The App instance to bind/pass to the group callable</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">(App $app = null)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 处理 callable，不详细解释请看 CallableResolverAwareTrait 源代码</span></span><br><span class="line">    $callable = <span class="keyword">$this</span>-&gt;resolveCallable(<span class="keyword">$this</span>-&gt;callable);</span><br><span class="line">    <span class="comment">// 将 $app 绑定到闭包的 $this</span></span><br><span class="line">    <span class="keyword">if</span> ($callable <span class="keyword">instanceof</span> Closure &amp;&amp; $app !== <span class="keyword">null</span>) &#123;</span><br><span class="line">        $callable = $callable-&gt;bindTo($app);</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="comment">// 执行 $callable 并将 $app 传参</span></span><br><span class="line">    $callable($app);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>注: 对 <code>bindTo</code> 方法不熟悉的同学可以看我之前写的博文 <a href="http://127.0.0.1:1111/posts/PHP-Clourse-%E9%97%AD%E5%8C%85%E7%B1%BB-%E6%B5%85%E6%9E%90.html" target="_blank" rel="noopener">PHP CLOURSE(闭包类) 浅析</a></em></p>
<p>上面的代码可能会有点蒙但结合路由组的使用 demo 便可以清楚的知道用途。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$app-&gt;group(<span class="string">'/users/&#123;id:[0-9]+&#125;'</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line"> <span class="keyword">$this</span>-&gt;map([<span class="string">'GET'</span>, <span class="string">'DELETE'</span>, <span class="string">'PATCH'</span>, <span class="string">'PUT'</span>], <span class="string">''</span>, <span class="function"><span class="keyword">function</span> <span class="params">($request, $response, $args)</span> </span>&#123;</span><br><span class="line"> <span class="comment">// Find, delete, patch or replace user identified by $args['id']</span></span><br><span class="line"> &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>当<code>App</code> 类的 <code>group</code> 方法被调用时 <code>$group($this)</code> 便会执行，在 <code>__invoke</code> 方法里将 <code>$app</code> 实例绑定到了 <code>$callable</code> 中（如果 <code>$callable</code> 是闭包），然后就可以通过 <code>$this-&gt;map(...)</code> 的方式注册路由，因为闭包中的 <code>$this</code> 便是 <code>$app</code>。如果 <code>$callable</code> 不是闭包，还可以通过参数的方式获取 <code>$app</code> 实例，因为在 <code>RouteGroup</code> 类的 <code>__invoke</code> 方法中通过 <code>$callable($app);</code> 来执行 <code>$callable</code>。</p>
<h2 id="0x07-注册中间件"><a href="#0x07-注册中间件" class="headerlink" title="0x07 注册中间件"></a>0x07 注册中间件</h2><p>Slim 的中间件包括「全局中间件」和「路由中间件」的注册都在 <code>MiddlewareAwareTrait</code> 性状里，注册中间件的方法为 <code>addMiddleware</code>，代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Add middleware</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This method prepends new middleware to the application middleware stack.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> callable $callable Any callable that accepts three arguments:</span></span><br><span class="line"><span class="comment"> *                           1. A Request object</span></span><br><span class="line"><span class="comment"> *                           2. A Response object</span></span><br><span class="line"><span class="comment"> *                           3. A "next" middleware callable</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> static</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> RuntimeException         If middleware is added while the stack is dequeuing</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> UnexpectedValueException If the middleware doesn't return a Psr\Http\Message\ResponseInterface</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addMiddleware</span><span class="params">(callable $callable)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 如果已经开始执行中间件则不允许再增加中间件</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;middlewareLock) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">'Middleware can’t be added once the stack is dequeuing'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 中间件为空则初始化</span></span><br><span class="line">    <span class="keyword">if</span> (is_null(<span class="keyword">$this</span>-&gt;tip)) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;seedMiddlewareStack();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 中间件打包</span></span><br><span class="line">    $next = <span class="keyword">$this</span>-&gt;tip;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;tip = <span class="function"><span class="keyword">function</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        ServerRequestInterface $request,</span></span></span><br><span class="line"><span class="function"><span class="params">        ResponseInterface $response</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span> <span class="title">use</span> <span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">        $callable,</span></span></span><br><span class="line"><span class="function"><span class="params">        $next</span></span></span><br><span class="line"><span class="function"><span class="params">    )</span> </span>&#123;</span><br><span class="line">        $result = call_user_func($callable, $request, $response, $next);</span><br><span class="line">        <span class="keyword">if</span> ($result <span class="keyword">instanceof</span> ResponseInterface === <span class="keyword">false</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UnexpectedValueException(</span><br><span class="line">                <span class="string">'Middleware must return instance of \Psr\Http\Message\ResponseInterface'</span></span><br><span class="line">            );</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> $result;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数的功能主要就是将原中间件闭包和现中间件闭包打包为一个闭包，想了解更多可以查看 <a href="https://www.0php.net/posts/PHP-%E6%A1%86%E6%9E%B6%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%AE%9E%E7%8E%B0.html">PHP 框架中间件实现</a></p>
<h2 id="0x08-开始与终结-Run"><a href="#0x08-开始与终结-Run" class="headerlink" title="0x08 开始与终结 Run"></a>0x08 开始与终结 Run</h2><p>在经历了创建容器、向容器注册默认服务、注册路由、注册中间件等步骤后我们终于到了 <code>$app-&gt;run();</code> 这最后一步(ㄒoㄒ)，下面让我们看看这 <code>run</code> 方法：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/********************************************************************************</span></span><br><span class="line"><span class="comment"> * Runner</span></span><br><span class="line"><span class="comment"> *******************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Run application</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This method traverses the application middleware stack and then sends the</span></span><br><span class="line"><span class="comment"> * resultant Response object to the HTTP client.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> bool|false $silent</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> ResponseInterface</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> MethodNotAllowedException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> NotFoundException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">($silent = false)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 获取 Response 实例</span></span><br><span class="line">    $response = <span class="keyword">$this</span>-&gt;container-&gt;get(<span class="string">'response'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 开启缓冲区</span></span><br><span class="line">        ob_start();</span><br><span class="line">        <span class="comment">// 处理请求</span></span><br><span class="line">        $response = <span class="keyword">$this</span>-&gt;process(<span class="keyword">$this</span>-&gt;container-&gt;get(<span class="string">'request'</span>), $response);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvalidMethodException $e) &#123;</span><br><span class="line">        <span class="comment">// 处理无效的方法</span></span><br><span class="line">        $response = <span class="keyword">$this</span>-&gt;processInvalidMethod($e-&gt;getRequest(), $response);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// 捕获 $response 以外的输出至 $output</span></span><br><span class="line">        $output = ob_get_clean();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 决定将 $output 加入到 $response 中的方式</span></span><br><span class="line">    <span class="comment">// 有三种方式：不加入、尾部追加、头部插入，具体根据 setting 决定，默认为尾部追加</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">empty</span>($output) &amp;&amp; $response-&gt;getBody()-&gt;isWritable()) &#123;</span><br><span class="line">        $outputBuffering = <span class="keyword">$this</span>-&gt;container-&gt;get(<span class="string">'settings'</span>)[<span class="string">'outputBuffering'</span>];</span><br><span class="line">        <span class="keyword">if</span> ($outputBuffering === <span class="string">'prepend'</span>) &#123;</span><br><span class="line">            <span class="comment">// prepend output buffer content</span></span><br><span class="line">            $body = <span class="keyword">new</span> Http\Body(fopen(<span class="string">'php://temp'</span>, <span class="string">'r+'</span>));</span><br><span class="line">            $body-&gt;write($output . $response-&gt;getBody());</span><br><span class="line">            $response = $response-&gt;withBody($body);</span><br><span class="line">        &#125; <span class="keyword">elseif</span> ($outputBuffering === <span class="string">'append'</span>) &#123;</span><br><span class="line">            <span class="comment">// append output buffer content</span></span><br><span class="line">            $response-&gt;getBody()-&gt;write($output);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 响应处理，主要是对空响应进行处理，对响应 Content-Length 进行设置等，不详细解释。</span></span><br><span class="line">    $response = <span class="keyword">$this</span>-&gt;finalize($response);</span><br><span class="line">    <span class="comment">// 发送响应至客户端</span></span><br><span class="line">    <span class="keyword">if</span> (!$silent) &#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;respond($response);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 返回 $response</span></span><br><span class="line">    <span class="keyword">return</span> $response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>注 1：对 <code>try...catch...finally</code> 不熟悉的同学可以看我之前写的博文 <a href="https://www.0php.net/posts/PHP-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E4%B8%89%E8%BF%9E-try-catch-finally.html">PHP 异常处理三连 TRY CATCH FINALLY</a></em></p>
<p><em>注 2：对 <code>ob_start</code> 和 <code>ob_get_clean</code> 函数不熟悉的同学也可以看我之前写的博文 <a href="https://www.0php.net/posts/PHP-%E8%BE%93%E5%87%BA%E7%BC%93%E5%86%B2%E5%8C%BA%E5%BA%94%E7%94%A8.html">PHP 输出缓冲区应用</a></em></p>
<p>可以看出上面最重要的就是 <code>process</code> 方法，该方法实现了处理「全局中间件栈」并返回最后的 <code>Response</code> 实例的功能，代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Process a request</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This method traverses the application middleware stack and then returns the</span></span><br><span class="line"><span class="comment"> * resultant Response object.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ServerRequestInterface $request</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ResponseInterface $response</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> ResponseInterface</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> MethodNotAllowedException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> NotFoundException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span><span class="params">(ServerRequestInterface $request, ResponseInterface $response)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// Ensure basePath is set</span></span><br><span class="line">    $router = <span class="keyword">$this</span>-&gt;container-&gt;get(<span class="string">'router'</span>);</span><br><span class="line">    <span class="comment">// 路由器设置 basePath</span></span><br><span class="line">    <span class="keyword">if</span> (is_callable([$request-&gt;getUri(), <span class="string">'getBasePath'</span>]) &amp;&amp; is_callable([$router, <span class="string">'setBasePath'</span>])) &#123;</span><br><span class="line">        $router-&gt;setBasePath($request-&gt;getUri()-&gt;getBasePath());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Dispatch the Router first if the setting for this is on</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">$this</span>-&gt;container-&gt;get(<span class="string">'settings'</span>)[<span class="string">'determineRouteBeforeAppMiddleware'</span>] === <span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="comment">// Dispatch router (<span class="doctag">note:</span> you won't be able to alter routes after this)</span></span><br><span class="line">        $request = <span class="keyword">$this</span>-&gt;dispatchRouterAndPrepareRoute($request, $router);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Traverse middleware stack</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 处理全局中间件栈</span></span><br><span class="line">        $response = <span class="keyword">$this</span>-&gt;callMiddlewareStack($request, $response);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">        $response = <span class="keyword">$this</span>-&gt;handleException($e, $request, $response);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable $e) &#123;</span><br><span class="line">        $response = <span class="keyword">$this</span>-&gt;handlePhpError($e, $request, $response);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们看处理「全局中间件栈」的方法 ，在 <code>MiddlewareAwareTrait</code> 里我们可以看见 <code>callMiddlewareStack</code> 方法代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注释讨论的是在 Slim\APP 类的情景</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Call middleware stack</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  ServerRequestInterface $request A request object</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  ResponseInterface      $response A response object</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> ResponseInterface</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">callMiddlewareStack</span><span class="params">(ServerRequestInterface $request, ResponseInterface $response)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// tip 是全部中间件合并之后的闭包</span></span><br><span class="line">    <span class="comment">// 如果 tip 为 null 说明不存在「全局中间件」</span></span><br><span class="line">    <span class="keyword">if</span> (is_null(<span class="keyword">$this</span>-&gt;tip)) &#123;</span><br><span class="line">        <span class="comment">// seedMiddlewareStack 函数的作用是设置 tip 的值</span></span><br><span class="line">        <span class="comment">// 默认设置为 $this</span></span><br><span class="line">        <span class="keyword">$this</span>-&gt;seedMiddlewareStack();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> callable $start */</span></span><br><span class="line">    $start = <span class="keyword">$this</span>-&gt;tip;</span><br><span class="line">    <span class="comment">// 锁住中间件确保在执行中间件代码时不会再增加中间件导致混乱</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;middlewareLock = <span class="keyword">true</span>;</span><br><span class="line">    <span class="comment">// 开始执行中间件</span></span><br><span class="line">    $response = $start($request, $response);</span><br><span class="line">    <span class="comment">// 取消中间件锁</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;middlewareLock = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> $response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看到上面可能会有疑惑，「路由的分配」和「路由中间件」的处理在哪里？如果你发现 <code>$app</code> 其实也是「全局中间件」处理的一环就会恍然大悟了，在 <code>Slim\App</code> 的 <code>__invoke</code> 方法里，我们可以看见「路由的分配」和「路由中间件」的处理，代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Invoke application</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This method implements the middleware interface. It receives</span></span><br><span class="line"><span class="comment"> * Request and Response objects, and it returns a Response object</span></span><br><span class="line"><span class="comment"> * after compiling the routes registered in the Router and dispatching</span></span><br><span class="line"><span class="comment"> * the Request object to the appropriate Route callback routine.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  ServerRequestInterface $request  The most recent Request object</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span>  ResponseInterface      $response The most recent Response object</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> ResponseInterface</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> MethodNotAllowedException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> NotFoundException</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">(ServerRequestInterface $request, ResponseInterface $response)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 获取路由信息</span></span><br><span class="line">    $routeInfo = $request-&gt;getAttribute(<span class="string">'routeInfo'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> \Slim\Interfaces\RouterInterface $router */</span></span><br><span class="line">    $router = <span class="keyword">$this</span>-&gt;container-&gt;get(<span class="string">'router'</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If router hasn't been dispatched or the URI changed then dispatch</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> === $routeInfo || ($routeInfo[<span class="string">'request'</span>] !== [$request-&gt;getMethod(), (string) $request-&gt;getUri()])) &#123;</span><br><span class="line">        <span class="comment">// Router 分配路由并将路由信息注入至 $request</span></span><br><span class="line">        $request = <span class="keyword">$this</span>-&gt;dispatchRouterAndPrepareRoute($request, $router);</span><br><span class="line">        $routeInfo = $request-&gt;getAttribute(<span class="string">'routeInfo'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 找到符合的路由</span></span><br><span class="line">    <span class="keyword">if</span> ($routeInfo[<span class="number">0</span>] === Dispatcher::FOUND) &#123;</span><br><span class="line">        <span class="comment">// 获取路由实例</span></span><br><span class="line">        $route = $router-&gt;lookupRoute($routeInfo[<span class="number">1</span>]);</span><br><span class="line">        <span class="comment">// 执行路由中间件并返回 $response</span></span><br><span class="line">        <span class="keyword">return</span> $route-&gt;run($request, $response);</span><br><span class="line">    <span class="comment">// HTTP 请求方法不允许处理</span></span><br><span class="line">    &#125; <span class="keyword">elseif</span> ($routeInfo[<span class="number">0</span>] === Dispatcher::METHOD_NOT_ALLOWED) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;container-&gt;has(<span class="string">'notAllowedHandler'</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> MethodNotAllowedException($request, $response, $routeInfo[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/** <span class="doctag">@var</span> callable $notAllowedHandler */</span></span><br><span class="line">        $notAllowedHandler = <span class="keyword">$this</span>-&gt;container-&gt;get(<span class="string">'notAllowedHandler'</span>);</span><br><span class="line">        <span class="keyword">return</span> $notAllowedHandler($request, $response, $routeInfo[<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 找不到路由处理</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;container-&gt;has(<span class="string">'notFoundHandler'</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NotFoundException($request, $response);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> callable $notFoundHandler */</span></span><br><span class="line">    $notFoundHandler = <span class="keyword">$this</span>-&gt;container-&gt;get(<span class="string">'notFoundHandler'</span>);</span><br><span class="line">    <span class="keyword">return</span> $notFoundHandler($request, $response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码抛开异常和错误处理，最主要的一句是 <code>return $route-&gt;run($request, $response);</code> 即 <code>Route</code> 类的 <code>run</code> 方法，代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Run route</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This method traverses the middleware stack, including the route's callable</span></span><br><span class="line"><span class="comment"> * and captures the resultant HTTP response object. It then sends the response</span></span><br><span class="line"><span class="comment"> * back to the Application.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ServerRequestInterface $request</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ResponseInterface      $response</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> ResponseInterface</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span><span class="params">(ServerRequestInterface $request, ResponseInterface $response)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// finalize 主要功能是将路由组上的中间件加入到该路由中</span></span><br><span class="line">    <span class="keyword">$this</span>-&gt;finalize();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用中间件栈，返回最后处理的 $response</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;callMiddlewareStack($request, $response);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实 <code>Route</code> 和 <code>App</code> 在处理中间件都使用了 <code>MiddlewareAwareTrait</code> 性状，所以在处理中间件的逻辑是一样的。那现在我们就看最后一步，<code>Route</code> 类的 <code>__invoke</code> 方法。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Dispatch route callable against current Request and Response objects</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This method invokes the route object's callable. If middleware is</span></span><br><span class="line"><span class="comment"> * registered for the route, each callable middleware is invoked in</span></span><br><span class="line"><span class="comment"> * the order specified.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ServerRequestInterface $request  The current Request object</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> ResponseInterface      $response The current Response object</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> \Psr\Http\Message\ResponseInterface</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> \Exception  if the route callable throws an exception</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">(ServerRequestInterface $request, ResponseInterface $response)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">$this</span>-&gt;callable = <span class="keyword">$this</span>-&gt;resolveCallable(<span class="keyword">$this</span>-&gt;callable);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** <span class="doctag">@var</span> InvocationStrategyInterface $handler */</span></span><br><span class="line">    $handler = <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;container) ? <span class="keyword">$this</span>-&gt;container-&gt;get(<span class="string">'foundHandler'</span>) : <span class="keyword">new</span> RequestResponse();</span><br><span class="line"></span><br><span class="line">    $newResponse = $handler(<span class="keyword">$this</span>-&gt;callable, $request, $response, <span class="keyword">$this</span>-&gt;arguments);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ($newResponse <span class="keyword">instanceof</span> ResponseInterface) &#123;</span><br><span class="line">        <span class="comment">// if route callback returns a ResponseInterface, then use it</span></span><br><span class="line">        $response = $newResponse;</span><br><span class="line">    &#125; <span class="keyword">elseif</span> (is_string($newResponse)) &#123;</span><br><span class="line">        <span class="comment">// if route callback returns a string, then append it to the response</span></span><br><span class="line">        <span class="keyword">if</span> ($response-&gt;getBody()-&gt;isWritable()) &#123;</span><br><span class="line">            $response-&gt;getBody()-&gt;write($newResponse);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $response;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这段代码的主要功能其实就是执行本路由的 <code>callback</code>函数，若 <code>callback</code> 返回 <code>Response</code> 实例便直接返回，否则将 <code>callback</code> 返回的字符串结果写入到原 <code>$response</code> 中并返回。</p>
<h2 id="0x09-总结"><a href="#0x09-总结" class="headerlink" title="0x09 总结"></a>0x09 总结</h2><p>额……感觉写的不好，但总算将整个流程解释了一遍。有些琐碎的地方就不解释了。其实框架的代码还算好读，有些地方解释起来感觉反而像画蛇添足，所以干脆贴了很多代码/(ㄒoㄒ)/~~。说实话将整个框架的代码通读一遍对水平的确会有所提升O(∩_∩)O，有兴趣的同学还是自己通读一遍较好，所以说这只是一篇走马观花的水文/(ㄒoㄒ)/~。 </p>
</div><br><p>转载请注明出处:<a href="https://www.0php.net/posts/Slim-框架源码解读.html" target="_blank" title="https://www.0php.net/posts/Slim-框架源码解读.html">https://www.0php.net/posts/Slim-框架源码解读.html</a></p><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br /><p>本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">知识共享署名-相同方式共享 4.0 国际许可协议</a>进行许可。</p><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-08-26</span><i class="fa fa-comment-o"></i><a href="/posts/Slim-框架源码解读.html#comments">评论</a><i class="fa fa-tag"></i><a class="tag" href="/tags/Slim/" title="Slim">Slim </a><a class="tag" href="/tags/框架/" title="框架">框架 </a><a class="tag" href="/tags/源码解读/" title="源码解读">源码解读 </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,https://www.0php.net/posts/Slim-框架源码解读.html,一只贱熊猫的博客,Slim 框架源码解读,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a class="btn" role="navigation" href="/posts/PHP-Clourse-闭包类-浅析.html" title="PHP Clourse(闭包类) 浅析">下一篇</a></li></ul></div><a id="comments"></a><div id="disqus_thread"></div><script>var disqus_shortname = 'zanemmm';
var disqus_identifier = 'posts/Slim-框架源码解读.html';
var disqus_title = 'Slim 框架源码解读';
var disqus_url = 'https://www.0php.net/posts/Slim-框架源码解读.html';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async></script></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>