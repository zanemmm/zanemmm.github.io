<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Zane,pi@0php.net"><title>PHP 框架中间件实现 · 一只贱熊猫的博客</title><meta name="description" content="0x00 前言中间件是很多 PHP 框架都提供的功能，在初次认识它的时候我感到惊讶和兴奋。因为它的作用太强大了，在没有中间件之前我们不得不将权限验证和一些公共操作都写在控制器方法里，然后控制器就会变得很臃肿，降低了可读性和可维护性。但有了中间件我们就可以这些操作都写在中间件里，然后通过使用不同的中间"><meta name="keywords" content="PHP,Web,Swoole,HTML,CSS"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">一只贱熊猫的博客</a></h3><div class="description"><p>夫夷以近，则游者众；险以远，则至者少。</p></div></div></div><ul class="social-links"><li><a href="http://github.com/zanemmm"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/logo.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>PHP 框架中间件实现</a></h3></div><div class="post-content"><h2 id="0x00-前言"><a href="#0x00-前言" class="headerlink" title="0x00 前言"></a>0x00 前言</h2><p>中间件是很多 PHP 框架都提供的功能，在初次认识它的时候我感到惊讶和兴奋。因为它的作用太强大了，在没有中间件之前我们不得不将权限验证和一些公共操作都写在控制器方法里，然后控制器就会变得很臃肿，降低了可读性和可维护性。但有了中间件我们就可以这些操作都写在中间件里，然后通过使用不同的中间件组合不仅能够实现需求还降低了代码的耦合度。既然中间件百般好，那它到底是如何实现的呢？在阅读 <code>Laravel</code> 和 <code>Slim</code> 的源码过程中（一个让人感觉很费劲，很折磨，觉得自己很菜的受虐过程/(ㄒoㄒ)/~~），我发现其重点就是要将多个中间件闭包（有些框架中间件并不是通过闭包实现但都属于 <code>callable</code> 的范畴，为了行文方便统称为闭包）通过 <code>reduce</code> 或循环的方式将其打包成为一个闭包的过程。</p>
<h2 id="0x01-预热"><a href="#0x01-预热" class="headerlink" title="0x01 预热"></a>0x01 预热</h2><p>一说道中间件往往就会让人联想到这幅图</p>
<p><img src="PHP-框架中间件实现/middleware.png" alt="middleware"></p>
<p>看起来很神奇很吓人的样子但是仔细观察一下，其实这个流程其实像不像函数的嵌套调用 <code>Middleware2(Middleware1(App()))</code> 呢？不过这样嵌套调用显然是错的，因为 PHP 先执行了 <code>App()</code> 而不是 <code>Middleware2</code> 但是如果比作嵌套的闭包呢？下面给出示例代码：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">$allMiddleware = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'start middleware2'</span> . PHP_EOL;</span><br><span class="line">  </span><br><span class="line">    (<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'start middleware1'</span> . PHP_EOL;</span><br><span class="line">        <span class="comment">// app</span></span><br><span class="line">        (<span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'app'</span> . PHP_EOL;</span><br><span class="line">        &#125;)();</span><br><span class="line">        <span class="comment">// end app</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'end middleware1'</span> . PHP_EOL;</span><br><span class="line">    &#125;)();</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'end middleware2'</span> . PHP_EOL;</span><br><span class="line">&#125;;</span><br><span class="line">$allMiddleware();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出</span></span><br><span class="line"><span class="comment">// start middleware2</span></span><br><span class="line"><span class="comment">// start middleware1</span></span><br><span class="line"><span class="comment">// app</span></span><br><span class="line"><span class="comment">// end middleware1</span></span><br><span class="line"><span class="comment">// end middleware2</span></span><br></pre></td></tr></table></figure>
<h2 id="0x02-思考"><a href="#0x02-思考" class="headerlink" title="0x02 思考"></a>0x02 思考</h2><p>嘿，上面的代码结果和预期一样，但这代码似乎有点简（ruo）陋（zhi）。但是其实上面代码中的 <code>$app</code> 就是中间件组合之后的结果，所以我们已经摸到门槛了，现在请思考如何将下列中间件闭包自动组合？</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数据库中间件</span></span><br><span class="line">$db = <span class="function"><span class="keyword">function</span> <span class="params">(Closure $next)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'成功建立数据库连接'</span> . PHP_EOL;</span><br><span class="line">    $next();</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'成功关闭数据库连接'</span> . PHP_EOL;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 点赞中间件</span></span><br><span class="line">$like = <span class="function"><span class="keyword">function</span> <span class="params">(Closure $next)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'点赞+1'</span> . PHP_EOL;</span><br><span class="line">    $next();</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'点赞+2'</span> . PHP_EOL;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// 内容闭包</span></span><br><span class="line">$app = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'文章内容'</span> . PHP_EOL;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>多了个参数 <code>$next</code> 是什么鬼？ <code>$next</code> 应该理解为「本中间件后所有中间件闭包函数打包成的一个闭包」，就以 <code>Middleware2</code> 而言，它的 <code>$next</code> 就是 <code>Middleware1</code> 和 <code>APP</code> 打包成的闭包（参照上图的最里面两层）。</p>
<h2 id="0x03-解答"><a href="#0x03-解答" class="headerlink" title="0x03 解答"></a>0x03 解答</h2><p>现给出答案代码如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// array_reduce 实现</span></span><br><span class="line">$allMiddleware = [$like, $db];</span><br><span class="line">$go = array_reduce($allMiddleware, <span class="function"><span class="keyword">function</span> <span class="params">($next, $middleware)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($next, $middleware)</span> </span>&#123;</span><br><span class="line">        $middleware($next);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;, $app);</span><br><span class="line">$go();</span><br><span class="line"></span><br><span class="line"><span class="comment">// foreach 实现</span></span><br><span class="line">$allMiddleware = [$like, $db];</span><br><span class="line">$next = $app;</span><br><span class="line"><span class="keyword">foreach</span> ($allMiddleware <span class="keyword">as</span> $middleware) &#123;</span><br><span class="line">    $next = <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($next, $middleware)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $middleware($next);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line">$next();</span><br></pre></td></tr></table></figure>
<p>两种实现方式但原理一样，所以只解释 <code>foreach</code> 版本的实现。首先是将所有的中间件组成一个数组，并将 <code>$next</code> 设置为 <code>$app</code>，然后开始循环的将 <code>$next</code> 和 <code>middleware</code> 组成一个新的闭包并赋值给 <code>$next</code>，这样 <code>$next</code> 便不断的将之前的闭包合并，最后变成一个。然后通过执行最后的 <code>$next</code> 即可得出结果。当然我空口白话的说可能还不好理解，最好的方式是将这代码自己在大脑执行一遍，还不行就动手画一下（我第一次看到这个代码就是这样才懂的/(ㄒoㄒ)/~~）然后就可以明白了。 此外不清楚 <code>array_reduce</code> 函数作用的可以 <a href="http://php.net/manual/zh/function.array-reduce.php" target="_blank" rel="noopener">点此</a>。</p>
<h2 id="0x04-好点的版本"><a href="#0x04-好点的版本" class="headerlink" title="0x04 好点的版本"></a>0x04 好点的版本</h2><p>为了好理解前面的中间件就只有 <code>$next</code> 参数，但实际框架的中间件都会有类似 <code>$request</code> 参数并且支持返回值 <code>$response</code>（比如 Laravel），下面是一个类似 Laravel 的中间件（仅仅是模仿，照虎画猫）实现代码。一法通，万法通，本菜逼就不解释了（万一涉及到我的知识盲区就 GG 了，O(∩_∩)O哈哈~）。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">$db = <span class="function"><span class="keyword">function</span> <span class="params">($request, Closure $next)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'成功建立数据库连接'</span> . PHP_EOL;</span><br><span class="line">    $response = $next($request);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'成功关闭数据库连接'</span> . PHP_EOL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $response;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">$like = <span class="function"><span class="keyword">function</span> <span class="params">($request, Closure $next)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'点赞+1'</span> . PHP_EOL;</span><br><span class="line">    $response = $next($request);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'点赞+2'</span> . PHP_EOL;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> $response;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">$app = <span class="function"><span class="keyword">function</span> <span class="params">($request)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> $request . PHP_EOL;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'一个无聊的返回值'</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">$allMiddleware = [$like, $db];</span><br><span class="line">$next = $app;</span><br><span class="line"><span class="keyword">foreach</span> ($allMiddleware <span class="keyword">as</span> $middleware) &#123;</span><br><span class="line">    $next = <span class="function"><span class="keyword">function</span> <span class="params">($request)</span> <span class="title">use</span> <span class="params">($middleware, $next)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> $middleware($request, $next);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$response = $next(<span class="string">'O(∩_∩)O'</span>);</span><br><span class="line"><span class="keyword">echo</span> $response;</span><br></pre></td></tr></table></figure>
<h2 id="0x05-总结"><a href="#0x05-总结" class="headerlink" title="0x05 总结"></a>0x05 总结</h2><p>(⊙v⊙)嗯，一点点内容就水了这么多，心满意足O(∩_∩)O哈哈~。另外文章中若出现错误，希望大家能够指出，若有疑问可以互相讨论:-D。</p>
</div><br><p>转载请注明出处:<a href="https://www.0php.net/posts/PHP-框架中间件实现.html" target="_blank" title="https://www.0php.net/posts/PHP-框架中间件实现.html">https://www.0php.net/posts/PHP-框架中间件实现.html</a></p><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br /><p>本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">知识共享署名-相同方式共享 4.0 国际许可协议</a>进行许可。</p><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2018-08-10</span><i class="fa fa-comment-o"></i><a href="/posts/PHP-框架中间件实现.html#comments">评论</a><i class="fa fa-tag"></i><a class="tag" href="/tags/PHP/" title="PHP">PHP </a><a class="tag" href="/tags/PHP-框架/" title="PHP 框架">PHP 框架 </a><a class="tag" href="/tags/中间件/" title="中间件">中间件 </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,https://www.0php.net/posts/PHP-框架中间件实现.html,一只贱熊猫的博客,PHP 框架中间件实现,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a class="btn" role="navigation" href="/posts/PHP-字符串相关常识.html" title="PHP 字符串相关常识">下一篇</a></li></ul></div><a id="comments"></a><div id="disqus_thread"></div><script>var disqus_shortname = 'zanemmm';
var disqus_identifier = 'posts/PHP-框架中间件实现.html';
var disqus_title = 'PHP 框架中间件实现';
var disqus_url = 'https://www.0php.net/posts/PHP-框架中间件实现.html';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//#{theme.disqus}.disqus.com/count.js" async></script></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>